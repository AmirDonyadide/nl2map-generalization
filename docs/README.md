# Online User Study (GitHub Pages + Google Sheets)

This folder contains the static website and supporting assets used to run the **online user study** for the thesis *Inferring Map Generalisation Operations from User Prompts* (Politecnico di Milano, 2025–2026).

The study collected **natural-language prompts** describing the transformation from an **input map** to a **generalised output map**. The interface was deployed on **GitHub Pages**, while session management and response storage were implemented using **Google Apps Script** with **Google Sheets** as the backend database.

---

## Purpose

The goal of the user study was to create a supervised dataset linking:

- an **input building tile** (vector map excerpt),
- a **generalised output tile** generated by a known operator + parameter,
- a **participant-written natural-language prompt**, and
- the corresponding **ground-truth labels**:
  - operator class (classification target)
  - parameter value (regression target)

At the time of conducting the study, no public dataset directly linked **map data + free-form user intent + operator + parameter value**, motivating the design of a dedicated data collection workflow.

---

## Study Setup (High-Level)

Participants completed a remote browser-based task:

1. Open the study link (GitHub Pages)
2. Enter name + access key (token) and consent
3. Read short instructions
4. Complete **24 trials**
   - left: **Input map**
   - right: **Output map**
   - write a short imperative prompt describing the transformation
5. Submit and finish

Participants were **not told** which operator, intensity, or parameter produced the output map, to avoid biasing their wording toward technical concepts.

---

## Architecture

The system uses a lightweight, serverless design:

- **Frontend:** static HTML/CSS/JS hosted on GitHub Pages (`docs/`)
- **Stimuli hosting:** paired PNGs hosted as static assets in this repo (`docs/images/pairs/`)
- **Backend API:** Google Apps Script Web App
  - session initialisation / resume (`init_session`)
  - per-trial response submission (`submit`)
- **Database:** Google Sheets
  - responses table
  - participants/session state
  - access tokens
  - assignments
  - quotas / balancing tables
  - tile catalogue / metadata

This design avoids maintaining a dedicated server while still supporting concurrency, persistent storage, and resumable sessions.

---

## Repository Contents (docs/)
```
docs/
├── images/
│ └── pairs/ # map pair stimuli (input/output PNGs)
├── index.html # UI entry point
├── script.js # client-side logic + API calls
├── style.css # styling
└── README.md # (this file)
```

---

## Stimuli Format

Each trial uses a pair of pre-rendered images:

- input map image (original buildings)
- output map image (generalised result)

The backend returns the URLs for each trial; the frontend only renders them.

Typical naming convention (example):

- `.../images/pairs/0123/input.png`
- `.../images/pairs/0123/output.png`

The exact naming depends on the preprocessing pipeline used to export stimuli into `docs/images/pairs/`.

---

## API Contract (Google Apps Script)

The frontend communicates with the Apps Script backend over HTTP.

### 1) Session initialisation / resume

**Request (JSON):**
```json
{
  "action": "init_session",
  "token": "<string>",
  "first_name": "<string>",
  "last_name": "<string>",
  "participant_id": "<string-optional>"
}
```

**Response (JSON):**
```json
  {
  "participant_id": "<string>",
  "answered_count": "<integer>",
  "trials": [
    {
      "assignment_id": "<string>",
      "tile_id": "<string>",
      "order_index": "<integer>",
      "input_image_url": "<string>",
      "output_image_url": "<string>"
    }
  ]
}
```

If participant_id is provided (stored in localStorage), the backend resumes the session.
answered_count enables the frontend to continue from the first unanswered trial.

### 2)Trial submission

**Request (JSON):**
```json
{
  "action": "init_session",
  "token": "<string>",
  "first_name": "<string>",
  "last_name": "<string>",
  "participant_id": "<string-optional>"
}
```

**Success response:**
```json
{ "ok": true }
```
**Duplicate submission response (example):**
```json
{ "ok": true, "skipped": "duplicate_assignment" }
```

---
## Concurrency Control

Google Apps Script is shared across all participants, so critical operations are protected with script-level locks:

- **Session initialisation lock**
  - Prevents race conditions in assignment and quota updates.

- **Submission lock**
  - Ensures consistency during append + validation + session state updates.

If a lock cannot be acquired within a timeout, the backend returns an error and the frontend can retry.

---

## Token / Access Key Logic

Access keys (tokens) are used to control participation and prevent duplicate sessions:

- Validated when a session is started (`init_session`).
- Marked as used only upon successful completion of the final trial.
- Names are used only for participation management; the modelling dataset uses anonymised identifiers.

---

## Assignment Logic (Balancing)

The backend assigns **24 trials per participant** using balancing constraints:

- Tiles are selected from predefined pools (e.g., **anchor / semi-anchor / unique**).
- Per-tile quotas control how often a tile can be assigned.
- Coverage constraints ensure diversity across:
  - **Operators:** simplify / select / aggregate / displace
  - **Intensity levels:** low / medium / high

Assigned tiles are shuffled before being returned to the frontend.

---

## Data Schema (Google Sheets)

Each submitted trial is stored as one row. Core fields:

- `participant_id` (anonymous session identifier)
- `tile_id` (key linking to tile metadata / stimuli)
- `free_text` (raw participant prompt)
- `timestamp`
- `duration_ms`
- `completed` (session-level completion flag)

Additional sheets are used for:

- participants registry
- assignments
- tile catalogue
- access keys
- quotas and balancing state

---

## Running / Editing Locally

You can test the frontend locally without deploying:

```bash
cd docs
python -m http.server 8000
```

Then open:
http://localhost:8000

> **Note:** API calls require a valid Google Apps Script endpoint configured in `script.js`.

---

## Deployment (GitHub Pages)

This folder is intended to be deployed via **GitHub Pages**.

**Configuration:**
- Pages source: `main` branch  
- Folder: `/docs`

After pushing changes, GitHub Pages will serve:

- `docs/index.html` as the entry point
- All stimuli under `docs/images/pairs/`

---

## Ethical Notes

- Participants provided informed consent before starting the study.
- Participation was restricted via access keys (not publicly open).
- Prompts were stored with anonymised participant identifiers.
- Names were collected solely for participation management and were not used as modelling features.

---

## Relation to Thesis

This online study supports the thesis chapter:

**User Study and Dataset Construction**

It provides the empirical foundation for training and evaluating models that predict:

- Generalisation operator (classification task)
- Operator parameter value (regression task)

---

## Maintainer

Amirhossein Donyadidegan  
MSc Geoinformatics Engineering  
Politecnico di Milano
